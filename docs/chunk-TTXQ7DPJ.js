import{C as P,J as d,Nb as w,O as V,Pb as f,Qb as x,T as y,a as b,b as S,c as v,i as M,l as g,q as I,r as u}from"./chunk-UUM5BDCX.js";var _=class C{constructor(e,i,t){this.http=e;this.storageService=i;this.indexedDBService=t;this.loadData()}dataLoaded=new M(!1);dataLoading=!1;partsCache=new Map;colorsCache=new Map;elementsCache=new Map;minifigsCache=new Map;inventoryPartsCache=new Map;inventoryMinifigsCache=new Map;cacheInitialized=!1;inventories=[];inventoryParts=[];inventoryMinifigs=[];inventorySets=[];parts=[];colors=[];partCategories=[];partRelationships=[];elements=[];minifigs=[];sets=[];themes=[];CSV_VERSION="1.0.4";loadData(){return v(this,null,function*(){if(!this.dataLoading){this.dataLoading=!0;try{let e=null;if(f.isSupported()){if((yield this.indexedDBService.isCSVCacheValid())&&(e=yield this.indexedDBService.loadCSVDataCache(),e?(console.log("CSV data loaded from IndexedDB cache:"),Object.keys(e).forEach(t=>{Array.isArray(e[t])?console.log(`  ${t}: ${e[t].length} records`):console.log(`  ${t}: ${typeof e[t]}`)})):console.log("No CSV data found in IndexedDB cache")),!e){e=yield this.loadFromCSVFiles(),console.log("CSV data loaded, preparing to save to IndexedDB:"),Object.keys(e).forEach(t=>{Array.isArray(e[t])?console.log(`  ${t}: ${e[t].length} records`):console.log(`  ${t}: ${typeof e[t]}`)});try{let t={inventories:e.inventories||[],inventoryParts:e.inventoryParts||[],inventoryMinifigs:e.inventoryMinifigs||[],inventorySets:e.inventorySets||[],parts:e.parts||[],colors:e.colors||[],partCategories:e.partCategories||[],partRelationships:e.partRelationships||[],elements:e.elements||[],minifigs:e.minifigs||[],sets:e.sets||[],themes:e.themes||[],timestamp:Date.now(),version:this.CSV_VERSION};console.log("Saving to IndexedDB with explicit structure..."),yield this.indexedDBService.saveCSVDataCache(t),console.log("Successfully saved CSV data to IndexedDB")}catch(t){console.warn("Failed to cache CSV data to IndexedDB, will continue with memory-only storage:",t)}}}else e=yield this.loadFromCSVFiles();this.loadDataIntoMemory(e),this.initializeCache(),this.dataLoaded.next(!0),this.dataLoading=!1}catch(e){console.error("DataService: Error loading data:",e),this.dataLoaded.next(!0),this.dataLoading=!1}}})}loadFromCSVFiles(){return v(this,null,function*(){let e;try{let s=yield this.http.get("assets/data/manifest.json",{responseType:"text"}).toPromise();e=JSON.parse(s||"{}")}catch{console.warn("No manifest file found, assuming single files for all CSVs"),e={inventories:1,inventory_parts:1,inventory_minifigs:1,inventory_sets:1,parts:1,colors:1,part_categories:1,part_relationships:1,elements:1,minifigs:1,sets:1,themes:1}}let i=[{key:"inventories",baseName:"inventories"},{key:"inventoryParts",baseName:"inventory_parts"},{key:"inventoryMinifigs",baseName:"inventory_minifigs"},{key:"inventorySets",baseName:"inventory_sets"},{key:"parts",baseName:"parts"},{key:"colors",baseName:"colors"},{key:"partCategories",baseName:"part_categories"},{key:"partRelationships",baseName:"part_relationships"},{key:"elements",baseName:"elements"},{key:"minifigs",baseName:"minifigs"},{key:"sets",baseName:"sets"},{key:"themes",baseName:"themes"}],t=[];i.forEach(({key:s,baseName:c})=>{let l=e[c]||1;if(l===1){let h=`assets/data/${c}.csv`,p=this.http.get(h,{responseType:"text"}).pipe(I(s==="inventoryParts"?12e4:6e4),u(r=>({key:s,csv:r,part:1,totalParts:1}))).toPromise();t.push(p)}else for(let h=1;h<=l;h++){let p=`assets/data/${c}_part_${h}.csv`,r=this.http.get(p,{responseType:"text"}).pipe(I(6e4),u(m=>({key:s,csv:m,part:h,totalParts:l}))).toPromise();t.push(r)}});let o=yield Promise.all(t),n={};i.forEach(({key:s})=>{n[s]=[]});let a=new Map;o.forEach(s=>{s&&(a.has(s.key)||a.set(s.key,[]),a.get(s.key).push(s))});for(let[s,c]of a)try{if(c.length===1)n[s]=this.parseCSV(c[0].csv);else{console.log(`Combining ${c.length} parts for ${s}`),c.sort((h,p)=>h.part-p.part);let l=[];for(let h=0;h<c.length;h++){let p=c[h];console.log(`Processing part ${h+1}/${c.length} for ${s}...`);let r=this.parseCSV(p.csv);h===0?l=r:l=l.concat(r),console.log(`Processed part ${h+1}/${c.length} for ${s}: ${r.length} records (total: ${l.length})`),r.length=0,h<c.length-1&&(yield new Promise(m=>setTimeout(m,10)))}n[s]=l,console.log(`Combined ${s}: ${l.length} total records`)}}catch(l){console.error(`Error parsing ${s}:`,l),n[s]=[]}return n})}loadDataIntoMemory(e){this.inventories=e.inventories||[],this.inventoryParts=e.inventoryParts||[],this.inventoryMinifigs=e.inventoryMinifigs||[],this.inventorySets=e.inventorySets||[],this.parts=e.parts||[],this.colors=e.colors||[],this.partCategories=e.partCategories||[],this.partRelationships=e.partRelationships||[],this.elements=e.elements||[],this.minifigs=e.minifigs||[],this.sets=e.sets||[],this.themes=e.themes||[]}initializeCache(){this.cacheInitialized||(this.parts.forEach(e=>{this.partsCache.set(e.part_num,e)}),this.colors.forEach(e=>{this.colorsCache.set(e.id,e)}),this.elements.forEach(e=>{this.elementsCache.set(e.element_id,e),this.elementsCache.set(`${e.part_num}_${e.color_id}`,e)}),this.minifigs.forEach(e=>{this.minifigsCache.set(e.fig_num,e)}),this.inventoryParts.forEach(e=>{this.inventoryPartsCache.has(e.inventory_id)||this.inventoryPartsCache.set(e.inventory_id,[]),this.inventoryPartsCache.get(e.inventory_id).push(e)}),this.inventoryMinifigs.forEach(e=>{this.inventoryMinifigsCache.has(e.inventory_id)||this.inventoryMinifigsCache.set(e.inventory_id,[]),this.inventoryMinifigsCache.get(e.inventory_id).push(e)}),this.cacheInitialized=!0)}refreshCSVData(){return v(this,null,function*(){try{return f.isSupported()&&(yield this.indexedDBService.clearCSVCache()),this.dataLoaded.next(!1),this.cacheInitialized=!1,this.dataLoading=!1,this.partsCache.clear(),this.colorsCache.clear(),this.elementsCache.clear(),this.minifigsCache.clear(),this.inventoryPartsCache.clear(),this.inventoryMinifigsCache.clear(),yield this.loadData(),!0}catch(e){return console.error("Error refreshing CSV data:",e),!1}})}parseCSV(e){let t=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);if(t.length<2)return[];let o=this.parseCSVLine(t[0]).map(a=>a.trim().replace(/\r/g,"").replace(/\n/g,"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"")),n=[];for(let a=1;a<t.length;a++){let s=t[a].trim();if(s)try{let c=this.parseCSVLine(s),l={};o.forEach((h,p)=>{let r=c[p]?.trim().replace(/\r/g,"").replace(/\n/g,"");r==null||r===""||(r==="true"||r==="false"||r==="True"||r==="False"?l[h]=r.toLowerCase()==="true":!isNaN(Number(r))&&r!==""?l[h]=Number(r):l[h]=r)}),Object.keys(l).length>0&&n.push(l)}catch(c){console.warn("Error parsing CSV line:",s,c)}}return n}parseCSVLine(e){let i=[],t="",o=!1,n=0;for(;n<e.length;){let a=e[n],s=e[n+1];a==='"'&&o&&s==='"'?(t+='"',n+=2):a==='"'?(o=!o,n++):a===","&&!o?(i.push(t.trim().replace(/\r/g,"")),t="",n++):(t+=a,n++)}return i.push(t.trim().replace(/\r/g,"")),i}isDataLoaded(){return this.dataLoaded.asObservable()}getSet(e,i=1){let t=this.sets.find(o=>o.set_num===e);if(t){let o=this.inventories.filter(n=>n.set_num===e).map(n=>n.version).sort((n,a)=>n-a);return g(S(b({},t),{versions:o.length>0?o:[1]}))}return g(void 0)}getSetInventory(e,i=1){let t=this.inventories.find(o=>o.set_num===e&&o.version===i);return g(t)}getSetInventoryPartsBySetNum(e,i=1){return this.getSetInventory(e,i).pipe(d(t=>t?this.getInventoryPartsFromCache(t.id):g([])))}getSetInventoryMinifigsBySetNum(e,i=1){return this.getSetInventory(e,i).pipe(d(t=>t?this.getInventoryMinifigsFromCache(t.id):g([])))}getInventoryPartsFromCache(e){if(!this.cacheInitialized)return this.dataLoaded.pipe(P(1),d(()=>{this.cacheInitialized||this.initializeCache();let t=this.inventoryPartsCache.get(e)||[];return g(t)}));let i=this.inventoryPartsCache.get(e)||[];return g(i)}getInventoryMinifigsFromCache(e){if(!this.cacheInitialized)return this.dataLoaded.pipe(P(1),d(()=>{this.cacheInitialized||this.initializeCache();let t=this.inventoryMinifigsCache.get(e)||[];return g(t)}));let i=this.inventoryMinifigsCache.get(e)||[];return g(i)}getSetsPaginated(e=1,i=24,t,o){return this.cacheInitialized?this.getSetsPaginatedInternal(e,i,t,o):this.dataLoaded.pipe(d(()=>this.getSetsPaginatedInternal(e,i,t,o)))}getSetsPaginatedInternal(e,i,t,o){let n=new Map;this.inventories.forEach(r=>{n.has(r.set_num)||n.set(r.set_num,[]),n.get(r.set_num).push(r.version)}),n.forEach((r,m)=>{n.set(m,r.sort((E,N)=>E-N))});let a=this.sets.map(r=>S(b({},r),{versions:n.get(r.set_num)||[1]}));if(t&&t.trim()){let r=t.toLowerCase();a=a.filter(m=>m.name.toLowerCase().includes(r)||m.set_num.toLowerCase().includes(r))}o&&(a=a.filter(r=>r.year===o));let s=a.length,c=(e-1)*i,l=c+i,h=a.slice(c,l),p=l<s;return g({sets:h,totalCount:s,hasNext:p})}getCurrentParts(){return this.parts}getCurrentColors(){return this.colors}getCurrentMinifigs(){return this.minifigs}getCurrentElements(){return this.elements}getCurrentSets(){return this.sets}getCurrentInventories(){return this.inventories}getCurrentInventoryParts(){return this.inventoryParts}getCurrentThemes(){return this.themes}getPartsByNumbers(e){let i=e.map(t=>this.partsCache.get(t)).filter(t=>t!==void 0);return g(i)}getColorsByIds(e){let i=e.map(t=>this.colorsCache.get(t)).filter(t=>t!==void 0);return g(i)}getElementsByIds(e){let i=e.map(t=>this.elementsCache.get(t)).filter(t=>t!==void 0);return g(i)}getMinifigsByNumbers(e){let i=e.map(t=>this.minifigsCache.get(t)).filter(t=>t!==void 0);return g(i)}getSetsFromCSV(){return this.getSetsPaginated(1,999999).pipe(u(e=>e.sets))}getSetInventoryPartsFromCSV(e){return this.getInventoryPartsFromCache(e)}getSetInventoryMinifigsFromCSV(e){return this.getInventoryMinifigsFromCache(e)}getPartCategoriesByIds(e){let i=this.partCategories.filter(t=>e.includes(t.id));return g(i)}getThemesByIds(e){let i=this.themes.filter(t=>e.includes(t.id));return g(i)}getCSVCacheInfo(){return v(this,null,function*(){return f.isSupported()?yield this.indexedDBService.getCSVCacheInfo():{exists:!1,timestamp:void 0,age:void 0,isValid:!1}})}getCurrentDataStats(){return{inventories:this.inventories.length,inventoryParts:this.inventoryParts.length,inventoryMinifigs:this.inventoryMinifigs.length,inventorySets:this.inventorySets.length,parts:this.parts.length,colors:this.colors.length,partCategories:this.partCategories.length,partRelationships:this.partRelationships.length,elements:this.elements.length,minifigs:this.minifigs.length,sets:this.sets.length,themes:this.themes.length,cacheInitialized:this.cacheInitialized,dataLoading:this.dataLoading}}static \u0275fac=function(i){return new(i||C)(y(w),y(x),y(f))};static \u0275prov=V({token:C,factory:C.\u0275fac,providedIn:"root"})};export{_ as a};
