import{C as P,J as f,Mb as w,O as V,Ob as u,Pb as _,T as b,a as d,b as y,c as v,i as M,l as c,q as I,r as C}from"./chunk-YYQQFFP3.js";var E=class S{constructor(e,i,t){this.http=e;this.storageService=i;this.indexedDBService=t;this.loadData()}dataLoaded=new M(!1);dataLoading=!1;partsCache=new Map;colorsCache=new Map;elementsCache=new Map;minifigsCache=new Map;inventoryPartsCache=new Map;inventoryMinifigsCache=new Map;cacheInitialized=!1;inventories=[];inventoryParts=[];inventoryMinifigs=[];inventorySets=[];parts=[];colors=[];partCategories=[];partRelationships=[];elements=[];minifigs=[];sets=[];themes=[];CSV_VERSION="1.0.3";loadData(){return v(this,null,function*(){if(!this.dataLoading){this.dataLoading=!0;try{let e=null;if(u.isSupported()){if((yield this.indexedDBService.isCSVCacheValid())&&(e=yield this.indexedDBService.loadCSVDataCache()),!e){e=yield this.loadFromCSVFiles();try{yield this.indexedDBService.saveCSVDataCache(y(d({},e),{timestamp:Date.now(),version:this.CSV_VERSION}))}catch(t){console.warn("Failed to cache CSV data to IndexedDB, will continue with memory-only storage:",t)}}}else e=yield this.loadFromCSVFiles();this.loadDataIntoMemory(e),this.initializeCache(),this.dataLoaded.next(!0),this.dataLoading=!1}catch(e){console.error("DataService: Error loading data:",e),this.dataLoaded.next(!0),this.dataLoading=!1}}})}loadFromCSVFiles(){return v(this,null,function*(){let e;try{let n=yield this.http.get("assets/data/manifest.json",{responseType:"text"}).toPromise();e=JSON.parse(n||"{}")}catch{console.warn("No manifest file found, assuming single files for all CSVs"),e={inventories:1,inventory_parts:1,inventory_minifigs:1,inventory_sets:1,parts:1,colors:1,part_categories:1,part_relationships:1,elements:1,minifigs:1,sets:1,themes:1}}let i=[{key:"inventories",baseName:"inventories"},{key:"inventoryParts",baseName:"inventory_parts"},{key:"inventoryMinifigs",baseName:"inventory_minifigs"},{key:"inventorySets",baseName:"inventory_sets"},{key:"parts",baseName:"parts"},{key:"colors",baseName:"colors"},{key:"partCategories",baseName:"part_categories"},{key:"partRelationships",baseName:"part_relationships"},{key:"elements",baseName:"elements"},{key:"minifigs",baseName:"minifigs"},{key:"sets",baseName:"sets"},{key:"themes",baseName:"themes"}],t=[];i.forEach(({key:n,baseName:l})=>{let h=e[l]||1;if(h===1){let m=`assets/data/${l}.csv`,p=this.http.get(m,{responseType:"text"}).pipe(I(n==="inventoryParts"?12e4:6e4),C(r=>({key:n,csv:r,part:1,totalParts:1}))).toPromise();t.push(p)}else for(let m=1;m<=h;m++){let p=`assets/data/${l}_part_${m}.csv`,r=this.http.get(p,{responseType:"text"}).pipe(I(6e4),C(g=>({key:n,csv:g,part:m,totalParts:h}))).toPromise();t.push(r)}});let o=yield Promise.all(t),s={};i.forEach(({key:n})=>{s[n]=[]});let a=new Map;return o.forEach(n=>{n&&(a.has(n.key)||a.set(n.key,[]),a.get(n.key).push(n))}),a.forEach((n,l)=>{try{if(n.length===1)s[l]=this.parseCSV(n[0].csv);else{console.log(`Combining ${n.length} parts for ${l}`),n.sort((p,r)=>p.part-r.part);let h=[],m=!1;n.forEach(p=>{let r=this.parseCSV(p.csv);m?h.push(...r):(h=r,m=!0)}),s[l]=h,console.log(`Combined ${l}: ${h.length} total records`)}}catch(h){console.error(`Error parsing ${l}:`,h),s[l]=[]}}),s})}loadDataIntoMemory(e){this.inventories=e.inventories||[],this.inventoryParts=e.inventoryParts||[],this.inventoryMinifigs=e.inventoryMinifigs||[],this.inventorySets=e.inventorySets||[],this.parts=e.parts||[],this.colors=e.colors||[],this.partCategories=e.partCategories||[],this.partRelationships=e.partRelationships||[],this.elements=e.elements||[],this.minifigs=e.minifigs||[],this.sets=e.sets||[],this.themes=e.themes||[]}initializeCache(){this.cacheInitialized||(this.parts.forEach(e=>{this.partsCache.set(e.part_num,e)}),this.colors.forEach(e=>{this.colorsCache.set(e.id,e)}),this.elements.forEach(e=>{this.elementsCache.set(e.element_id,e),this.elementsCache.set(`${e.part_num}_${e.color_id}`,e)}),this.minifigs.forEach(e=>{this.minifigsCache.set(e.fig_num,e)}),this.inventoryParts.forEach(e=>{this.inventoryPartsCache.has(e.inventory_id)||this.inventoryPartsCache.set(e.inventory_id,[]),this.inventoryPartsCache.get(e.inventory_id).push(e)}),this.inventoryMinifigs.forEach(e=>{this.inventoryMinifigsCache.has(e.inventory_id)||this.inventoryMinifigsCache.set(e.inventory_id,[]),this.inventoryMinifigsCache.get(e.inventory_id).push(e)}),this.cacheInitialized=!0)}refreshCSVData(){return v(this,null,function*(){try{return u.isSupported()&&(yield this.indexedDBService.clearCSVCache()),this.dataLoaded.next(!1),this.cacheInitialized=!1,this.dataLoading=!1,this.partsCache.clear(),this.colorsCache.clear(),this.elementsCache.clear(),this.minifigsCache.clear(),this.inventoryPartsCache.clear(),this.inventoryMinifigsCache.clear(),yield this.loadData(),!0}catch(e){return console.error("Error refreshing CSV data:",e),!1}})}parseCSV(e){let t=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);if(t.length<2)return[];let o=this.parseCSVLine(t[0]).map(a=>a.trim().replace(/\r/g,"").replace(/\n/g,"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"")),s=[];for(let a=1;a<t.length;a++){let n=t[a].trim();if(n)try{let l=this.parseCSVLine(n),h={};o.forEach((m,p)=>{let r=l[p]?.trim().replace(/\r/g,"").replace(/\n/g,"");r==null||r===""||(r==="true"||r==="false"||r==="True"||r==="False"?h[m]=r.toLowerCase()==="true":!isNaN(Number(r))&&r!==""?h[m]=Number(r):h[m]=r)}),Object.keys(h).length>0&&s.push(h)}catch(l){console.warn("Error parsing CSV line:",n,l)}}return s}parseCSVLine(e){let i=[],t="",o=!1,s=0;for(;s<e.length;){let a=e[s],n=e[s+1];a==='"'&&o&&n==='"'?(t+='"',s+=2):a==='"'?(o=!o,s++):a===","&&!o?(i.push(t.trim().replace(/\r/g,"")),t="",s++):(t+=a,s++)}return i.push(t.trim().replace(/\r/g,"")),i}isDataLoaded(){return this.dataLoaded.asObservable()}getSet(e,i=1){let t=this.sets.find(o=>o.set_num===e);if(t){let o=this.inventories.filter(s=>s.set_num===e).map(s=>s.version).sort((s,a)=>s-a);return c(y(d({},t),{versions:o.length>0?o:[1]}))}return c(void 0)}getSetInventory(e,i=1){let t=this.inventories.find(o=>o.set_num===e&&o.version===i);return c(t)}getSetInventoryPartsBySetNum(e,i=1){return this.getSetInventory(e,i).pipe(f(t=>t?this.getInventoryPartsFromCache(t.id):c([])))}getSetInventoryMinifigsBySetNum(e,i=1){return this.getSetInventory(e,i).pipe(f(t=>t?this.getInventoryMinifigsFromCache(t.id):c([])))}getInventoryPartsFromCache(e){if(!this.cacheInitialized)return this.dataLoaded.pipe(P(1),f(()=>{this.cacheInitialized||this.initializeCache();let t=this.inventoryPartsCache.get(e)||[];return c(t)}));let i=this.inventoryPartsCache.get(e)||[];return c(i)}getInventoryMinifigsFromCache(e){if(!this.cacheInitialized)return this.dataLoaded.pipe(P(1),f(()=>{this.cacheInitialized||this.initializeCache();let t=this.inventoryMinifigsCache.get(e)||[];return c(t)}));let i=this.inventoryMinifigsCache.get(e)||[];return c(i)}getSetsPaginated(e=1,i=24,t,o){return this.cacheInitialized?this.getSetsPaginatedInternal(e,i,t,o):this.dataLoaded.pipe(f(()=>this.getSetsPaginatedInternal(e,i,t,o)))}getSetsPaginatedInternal(e,i,t,o){let s=new Map;this.inventories.forEach(r=>{s.has(r.set_num)||s.set(r.set_num,[]),s.get(r.set_num).push(r.version)}),s.forEach((r,g)=>{s.set(g,r.sort((x,N)=>x-N))});let a=this.sets.map(r=>y(d({},r),{versions:s.get(r.set_num)||[1]}));if(t&&t.trim()){let r=t.toLowerCase();a=a.filter(g=>g.name.toLowerCase().includes(r)||g.set_num.toLowerCase().includes(r))}o&&(a=a.filter(r=>r.year===o));let n=a.length,l=(e-1)*i,h=l+i,m=a.slice(l,h),p=h<n;return c({sets:m,totalCount:n,hasNext:p})}getCurrentParts(){return this.parts}getCurrentColors(){return this.colors}getCurrentMinifigs(){return this.minifigs}getCurrentElements(){return this.elements}getCurrentSets(){return this.sets}getCurrentInventories(){return this.inventories}getCurrentInventoryParts(){return this.inventoryParts}getCurrentThemes(){return this.themes}getPartsByNumbers(e){let i=e.map(t=>this.partsCache.get(t)).filter(t=>t!==void 0);return c(i)}getColorsByIds(e){let i=e.map(t=>this.colorsCache.get(t)).filter(t=>t!==void 0);return c(i)}getElementsByIds(e){let i=e.map(t=>this.elementsCache.get(t)).filter(t=>t!==void 0);return c(i)}getMinifigsByNumbers(e){let i=e.map(t=>this.minifigsCache.get(t)).filter(t=>t!==void 0);return c(i)}getSetsFromCSV(){return this.getSetsPaginated(1,999999).pipe(C(e=>e.sets))}getSetInventoryPartsFromCSV(e){return this.getInventoryPartsFromCache(e)}getSetInventoryMinifigsFromCSV(e){return this.getInventoryMinifigsFromCache(e)}getPartCategoriesByIds(e){let i=this.partCategories.filter(t=>e.includes(t.id));return c(i)}getThemesByIds(e){let i=this.themes.filter(t=>e.includes(t.id));return c(i)}getCSVCacheInfo(){return v(this,null,function*(){return u.isSupported()?yield this.indexedDBService.getCSVCacheInfo():{exists:!1,timestamp:void 0,age:void 0,isValid:!1}})}static \u0275fac=function(i){return new(i||S)(b(w),b(_),b(u))};static \u0275prov=V({token:S,factory:S.\u0275fac,providedIn:"root"})};export{E as a};
